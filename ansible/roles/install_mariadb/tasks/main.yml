---
- name: Install pip
  ansible.builtin.apt:
    name: python3-pip
    state: present
    update_cache: yes

- name: Install PyMySQL
  ansible.builtin.pip:
    name: pymysql
    state: present

- name: Install MariaDB
  ansible.builtin.apt:
    name: mariadb-server={{ mariadb_version }}
    state: present
    update_cache: yes
  become: true

- name: secure mariadb
  ansible.builtin.expect:
    command: mysql_secure_installation
    responses:
      "Enter current password for root": ""
      "Set root password": "n"
      "Remove anonymous users": "y"
      "Disallow root login remotely": "y"
      "Remove test database": "y"
      "Reload privilege tables now": "y"
    timeout: 1
  register: secure_mariadb
  failed_when: "'... Failed!' in secure_mariadb.stdout_lines"
  become: true

- name: Create Nextcloud Database
  ansible.builtin.mysql_db:
    name: "{{ nextcloud_database_name }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  become: true

- name: Create Nextcloud Database User with full privilege to Nextcloud User
  ansible.builtin.mysql_user:
    name: "{{ nextcloud_database_user }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
    host: "{{ nextcloud_host }}"
    password: "{{ nextcloud_database_password }}"
    priv: "{{ nextcloud_database_name }}.*:ALL"
    state: present
  become: true

- name: Replace bind-address in MariaDB config
  ansible.builtin.replace:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: "127.0.0.1"
    replace: "0.0.0.0"
  become: true
  notify: Restart mariadb-server service

- name: Enable Mariadb service
  ansible.builtin.service:
      name: mariadb
      enabled: yes
  notify: Restart mariadb-server service

- name: Include Prometheus setup
  include_role:
    name: install_prometheus

- name: Include node_exporter setup
  include_role:
    name: install_node_exporter

- name: Add job to Prometheus configuration
  ansible.builtin.lineinfile:
    path: "/etc/prometheus/prometheus.yml"
    line: "  - job_name: 'remote_collector'\n  scrape_interval: 10s\n  static_configs:\n    - targets: ['{{mariadb_host}}:9100']"
    insertafter: EOF
    state: present
  notify: Restart prometheus service
