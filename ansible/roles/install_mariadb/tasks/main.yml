---
- name: Install pip
  ansible.builtin.apt:
    name: python3-pip
    state: present
    update_cache: yes

- name: Install PyMySQL
  ansible.builtin.pip:
    name: pymysql
    state: present

- name: Install MariaDB
  ansible.builtin.apt:
    name: mariadb-server
    state: present
    update_cache: yes
  become: true

- name: secure mariadb
  ansible.builtin.expect:
    command: mysql_secure_installation
    responses:
      "Enter current password for root": ""
      "Set root password": "n"
      "Remove anonymous users": "y"
      "Disallow root login remotely": "y"
      "Remove test database": "y"
      "Reload privilege tables now": "y"
    timeout: 1
  register: secure_mariadb
  failed_when: "'... Failed!' in secure_mariadb.stdout_lines"
  become: true

- name: Create Nextcloud Database
  ansible.builtin.mysql_db:
    name: nextcloud
    login_unix_socket: /var/run/mysqld/mysqld.sock
  become: true

- name: Create Nextcloud Database User
  ansible.builtin.mysql_user:
    name: nextclouduser
    login_unix_socket: /var/run/mysqld/mysqld.sock
    host: "{{ nextcloud_db_host }}"
    password: "{{ nextcloud_db_password }}"
    priv: "nextcloud.*:ALL"
    state: present
  become: true

- name: Replace bind-address in MariaDB config
  ansible.builtin.replace:
    path: /etc/mysql/mariadb.conf.d/50-server.cnf
    regexp: '127.0.0.1'
    replace: '0.0.0.0'
  become: true

- name: Restart service mariadb-server
  ansible.builtin.service:
    name: mariadb
    state: restarted
