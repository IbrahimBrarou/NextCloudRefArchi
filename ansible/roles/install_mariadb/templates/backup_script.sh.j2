#!/bin/bash

# MySQL/MariaDB server details
server="{{ mariadb_host }}"
username="{{ nextcloud_database_user }}"
password="{{ nextcloud_database_password }}"
db_name="{{ nextcloud_database_name }}"
backup_dest_dir="{{ backup_dest_dir }}"
backup_file="{{ backup_dest_dir }}/nextcloud-sqlbkp_$(date +"%Y%m%d").bak"
archive_period={{ backup_archive_period }}

# Generate a backup directory in case it is not already present
mkdir -p $backup_dest_dir

# Perform database backup using mysqldump
mysqldump --single-transaction -h $server -u $username -p$password $db_name > $backup_file


# Check if backup was successful
if [ $? -eq 0 ]; then
    echo "Database backup completed successfully: $backup_file"
else
    echo "Database backup failed."
fi

# Rotation logic - Keep backup only for archive_period of 5 days
find $backup_dest_dir -name 'nextcloud-sqlbkp_*.bak' -type f -mtime +$archive_period -delete